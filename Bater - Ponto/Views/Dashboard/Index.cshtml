@model List<Bater_Ponto.Models.RegistroPonto>

@{
    ViewData["Title"] = "Dashboard";

    var saldo = ViewBag.SaldoTotal as TimeSpan? ?? TimeSpan.Zero;
    var totalTrabalhado = ViewBag.TotalTrabalhado as TimeSpan? ?? TimeSpan.Zero;
    var diasPositivos = ViewBag.DiasPositivos ?? 0;
    var diasNegativos = ViewBag.DiasNegativos ?? 0;

    var sinalSaldo = saldo < TimeSpan.Zero ? "-" : "+";
    var saldoFormatado = saldo.Duration().ToString(@"hh\:mm\:ss");

    var horasHoje = ViewBag.HorasTrabalhadasHoje as TimeSpan? ?? TimeSpan.Zero;
    var percentualHoje = ViewBag.PercentualHoje ?? 0.0;
    var metaDiaria = ViewBag.MetaDiaria as TimeSpan? ?? TimeSpan.Zero;
    var restanteHoje = ViewBag.RestanteHoje as TimeSpan? ?? TimeSpan.Zero;
    var metaConcluida = ViewBag.MetaConcluida ?? false;

    var totalSemana = ViewBag.TotalSemana as TimeSpan? ?? TimeSpan.Zero;
    var metaSemanaEsperada = ViewBag.MetaSemanaEsperada as TimeSpan? ?? TimeSpan.Zero;
    var saldoSemana = ViewBag.SaldoSemana as TimeSpan? ?? TimeSpan.Zero;

    var corBarra = percentualHoje < 100 ? "bg-warning" : "bg-success";
    var corSaldoSemana = saldoSemana < TimeSpan.Zero ? "bg-danger" : "bg-success";
}

<h2>Dashboard</h2>

<form method="get" class="row g-3">
    <div class="col-md-3">
        <label>Data Início</label>
        <input type="date" name="dataInicio" class="form-control"
               value="@(ViewBag.DataInicio != null ? ((DateTime)ViewBag.DataInicio).ToString("yyyy-MM-dd") : "")" />
    </div>

    <div class="col-md-3">
        <label>Data Fim</label>
        <input type="date" name="dataFim" class="form-control"
               value="@(ViewBag.DataFim != null ? ((DateTime)ViewBag.DataFim).ToString("yyyy-MM-dd") : "")" />
    </div>

    <div class="col-md-3 align-self-end">
        <button type="submit" class="btn btn-success">Filtrar</button>
    </div>
</form>

<hr />

<!-- 📊 RESUMO GERAL -->
<div class="row mb-4">

    <div class="col-md-3">
        <div class="card text-white bg-primary shadow p-3">
            <h6>Total Trabalhado</h6>
            <h4>@totalTrabalhado.ToString(@"hh\:mm\:ss")</h4>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-white @(saldo < TimeSpan.Zero ? "bg-danger" : "bg-success") shadow p-3">
            <h6>Saldo no Período</h6>
            <h4>@($"{sinalSaldo}{saldoFormatado}")</h4>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-white bg-success shadow p-3">
            <h6>Dias Positivos</h6>
            <h4>@diasPositivos</h4>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card text-white bg-danger shadow p-3">
            <h6>Dias Negativos</h6>
            <h4>@diasNegativos</h4>
        </div>
    </div>

</div>

<!-- 📅 META SEMANAL -->
<div class="row mb-4">

    <div class="col-md-4">
        <div class="card text-white bg-info shadow p-3">
            <h6>Total Trabalhado na Semana</h6>
            <h4>@totalSemana.ToString(@"hh\:mm\:ss")</h4>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-white bg-secondary shadow p-3">
            <h6>Meta Esperada até Hoje</h6>
            <h4>@metaSemanaEsperada.ToString(@"hh\:mm\:ss")</h4>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-white @corSaldoSemana shadow p-3">
            <h6>Saldo da Semana</h6>
            <h4>
                @(saldoSemana < TimeSpan.Zero ? "-" : "+")
                @saldoSemana.Duration().ToString(@"hh\:mm\:ss")
            </h4>
        </div>
    </div>

</div>

<!-- 🎯 META DO DIA -->
<div class="card shadow p-3 mb-4">
    <h6>Meta de Hoje (@metaDiaria.ToString(@"hh\:mm"))</h6>

    <div class="progress" style="height: 25px;">
        <div class="progress-bar @corBarra"
             role="progressbar"
             style="width: @percentualHoje%;"
             aria-valuenow="@percentualHoje"
             aria-valuemin="0"
             aria-valuemax="100">
            @percentualHoje.ToString("0")%
        </div>
    </div>

    <small class="text-muted d-block">
        Trabalhado hoje: @horasHoje.ToString(@"hh\:mm\:ss")
    </small>

    @if (!metaConcluida)
    {
        <small class="text-warning fw-bold d-block">
            Hoje você ainda precisa trabalhar @restanteHoje.ToString(@"hh\:mm\:ss")
        </small>
    }
    else
    {
        <small class="text-success fw-bold d-block">
            Meta diária concluída 🎉
        </small>
    }
</div>

<a href="/Ponto" class="btn btn-primary mb-3">Registrar Ponto</a>

<hr />

<h4>Saldo Acumulado</h4>
<canvas id="graficoSaldo" height="100"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const datas = [];
    const saldos = [];

    let acumulado = 0;

    @foreach (var item in Model.OrderBy(r => r.Data))
    {
            var saldoDia = item.CalcularSaldoDia();
            var valor = saldoDia != null ? saldoDia.Value.TotalHours : 0;

            <text>
                datas.push("@item.Data.ToString("dd/MM")");
                acumulado += @valor.ToString(System.Globalization.CultureInfo.InvariantCulture);
                saldos.push(acumulado);
            </text>
    }

    const ctx = document.getElementById('graficoSaldo').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: datas,
            datasets: [{
                label: 'Saldo Acumulado (Horas)',
                data: saldos,
                borderColor: '#198754',
                backgroundColor: 'rgba(25,135,84,0.2)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true
        }
    });
</script>